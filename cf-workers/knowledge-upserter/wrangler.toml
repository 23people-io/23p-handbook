name = "23people-handbook-knowledge-upserter"
compatibility_flags = ["nodejs_compat"]
main = "src/index.ts"
compatibility_date = "2025-01-01"

[observability]
enabled = true

[vars]
OPENAI_EMBEDDINGS_MODEL = "text-embedding-3-small"
OPENAI_EMBEDDINGS_DIMENSIONS = 768
OPENAI_EMBEDDINGS_API_ENDPOINT = "https://api.openai.com/v1/embeddings"
REPO_NAME = "23people-handbook"
REPO_OWNER = "23people-io"

[[queues.consumers]]
queue = "23people-docs-to-index-queue" 

# Bind the Workers AI model catalog. Run machine learning models, powered by serverless GPUs, on Cloudflareâ€™s global network
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/#workers-ai
[ai]
binding = "AI" # available in your Worker on env.AI

# Bind a Vectorize index. Use to store and query vector embeddings for semantic search, classification and other vector search use-cases.
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/#vectorize-indexes
[[vectorize]]
binding = "VECTORIZE_INDEX_ID" # available in your Worker on env.VECTORIZE_INDEX_ID
index_name = "handbook-index-2" # the name of the index

[env.test]
name = "knowledge-upserter-test"

[[env.test.queues.consumers]]
queue = "DOCS_TO_INDEX_QUEUE"
max_batch_size = 10
max_batch_timeout = 5
max_retries = 3

[[env.test.queues.producers]]
queue = "DOCS_TO_INDEX_QUEUE"
binding = "DOCS_TO_INDEX_QUEUE"